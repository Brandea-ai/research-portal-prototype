<div class="page">
  <div class="page__header">
    <h2 class="page__title">{{ 'REPORTS.PAGE_TITLE' | translate }}</h2>
    <div class="page__header-actions">
      <span class="page__count">{{ filteredReports().length }} von {{ reports().length }} Reports</span>
      <div class="export-group">
        <button class="btn-export" (click)="exportCsv()">CSV</button>
        <button class="btn-export" (click)="exportExcel()">Excel</button>
      </div>
      <button class="btn-create" (click)="createReport()">{{ 'REPORTS.NEW_REPORT' | translate }}</button>
    </div>
  </div>

  <!-- Filter-Leiste -->
  <div class="filter-bar">
    <div class="filter-bar__controls">
      <div class="filter-group">
        <label class="filter-label" for="filter-type">{{ 'REPORTS.FILTERS.TYPE_LABEL' | translate }}</label>
        <select
          id="filter-type"
          class="filter-select"
          [ngModel]="filterType()"
          (ngModelChange)="filterType.set($event)">
          @for (type of reportTypes; track type) {
            <option [value]="type">{{ formatFilterLabel(type) }}</option>
          }
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="filter-rating">{{ 'REPORTS.FILTERS.RATING_LABEL' | translate }}</label>
        <select
          id="filter-rating"
          class="filter-select"
          [ngModel]="filterRating()"
          (ngModelChange)="filterRating.set($event)">
          @for (rating of ratingOptions; track rating) {
            <option [value]="rating">{{ formatFilterLabel(rating) }}</option>
          }
        </select>
      </div>

      <div class="filter-group filter-group--search">
        <label class="filter-label" for="filter-search">{{ 'REPORTS.FILTERS.SEARCH_LABEL' | translate }}</label>
        <input
          id="filter-search"
          type="text"
          class="filter-input"
          [placeholder]="'REPORTS.FILTERS.SEARCH_PLACEHOLDER' | translate"
          [ngModel]="searchTerm()"
          (ngModelChange)="onSearchInput($event)" />
      </div>
    </div>

    @if (activeFilterCount() > 0) {
      <div class="filter-bar__status">
        <span class="filter-count">{{ activeFilterCount() }} {{ 'REPORTS.FILTERS.ACTIVE_FILTERS' | translate:{count: activeFilterCount()} }}</span>
        <button class="filter-reset" (click)="resetFilters()">{{ 'REPORTS.FILTERS.RESET' | translate }}</button>
      </div>
    }
  </div>

  @if (loading()) {
    <p class="loading">{{ 'REPORTS.LOADING' | translate }}</p>
  } @else {
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>{{ 'REPORTS.TABLE.TITLE' | translate }}</th>
            <th>{{ 'REPORTS.TABLE.TYPE' | translate }}</th>
            <th class="hide-mobile">{{ 'REPORTS.TABLE.ANALYST' | translate }}</th>
            <th>{{ 'REPORTS.TABLE.RATING' | translate }}</th>
            <th class="text-right sortable" (click)="toggleSort('targetPrice')">
              {{ 'REPORTS.TABLE.TARGET_PRICE' | translate }}{{ getSortIndicator('targetPrice') }}
            </th>
            <th class="text-right hide-mobile">{{ 'REPORTS.TABLE.PRICE' | translate }}</th>
            <th class="text-right sortable hide-mobile" (click)="toggleSort('impliedUpside')">
              {{ 'REPORTS.TABLE.UPSIDE' | translate }}{{ getSortIndicator('impliedUpside') }}
            </th>
            <th class="sortable" (click)="toggleSort('publishedAt')">
              {{ 'REPORTS.TABLE.DATE' | translate }}{{ getSortIndicator('publishedAt') }}
            </th>
          </tr>
        </thead>
        <tbody>
          @for (report of filteredReports(); track report.id) {
            <tr (click)="openReport(report.id)">
              <td class="cell-title">{{ report.title }}</td>
              <td>
                <span class="type-badge">{{ formatType(report.reportType) }}</span>
              </td>
              <td class="cell-analyst hide-mobile">{{ getAnalystName(report.analystId) }}</td>
              <td>
                <span class="rating" [class]="'rating--' + ratingClass(report.rating)">
                  {{ formatRating(report.rating) }}
                </span>
                @if (report.ratingChanged && report.previousRating) {
                  <span class="rating-prev">{{ formatRating(report.previousRating) }}</span>
                }
              </td>
              <td class="text-right mono">CHF {{ report.targetPrice | number:'1.2-2' }}</td>
              <td class="text-right mono hide-mobile">CHF {{ report.currentPrice | number:'1.2-2' }}</td>
              <td class="text-right mono hide-mobile" [class]="report.impliedUpside >= 0 ? 'text-right mono hide-mobile text-positive' : 'text-right mono hide-mobile text-negative'">
                {{ report.impliedUpside | number:'1.1-1' }}%
              </td>
              <td class="cell-date">{{ report.publishedAt | date:'dd.MM.yyyy' }}</td>
            </tr>
          }
          @if (filteredReports().length === 0) {
            <tr>
              <td class="empty-state" colspan="8">{{ 'REPORTS.EMPTY' | translate }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>
