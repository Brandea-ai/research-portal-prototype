@if (loading()) {
  <div class="page">
    <p class="loading-text">Daten werden geladen...</p>
  </div>
} @else {
  <div class="page">

    <!-- Header -->
    <div class="form-header">
      <a class="back-link" routerLink="/reports">Zurück zur Übersicht</a>
      <h1 class="form-title">{{ pageTitle() }}</h1>
    </div>

    <!-- Error -->
    @if (error()) {
      <div class="error-banner">
        <span class="error-banner__text">{{ error() }}</span>
      </div>
    }

    <!-- Form -->
    <form class="report-form" [formGroup]="form" (ngSubmit)="onSubmit()">

      <!-- Analyst + Security -->
      <div class="form-row form-row--2col">
        <div class="form-field">
          <label class="form-label" for="analystId">Analyst</label>
          <select class="form-select" id="analystId" formControlName="analystId">
            <option [value]="0" disabled>Analyst wählen</option>
            @for (a of analysts(); track a.id) {
              <option [value]="a.id">{{ a.name }}</option>
            }
          </select>
          @if (isFieldInvalid('analystId')) {
            <span class="form-error">Bitte wählen Sie einen Analysten.</span>
          }
        </div>

        <div class="form-field">
          <label class="form-label" for="securityId">Wertschrift</label>
          <select class="form-select" id="securityId" formControlName="securityId">
            <option [value]="0" disabled>Wertschrift wählen</option>
            @for (s of securities(); track s.id) {
              <option [value]="s.id">{{ s.ticker }} — {{ s.name }}</option>
            }
          </select>
          @if (isFieldInvalid('securityId')) {
            <span class="form-error">Bitte wählen Sie eine Wertschrift.</span>
          }
        </div>
      </div>

      <!-- Report-Typ + Rating -->
      <div class="form-row form-row--2col">
        <div class="form-field">
          <label class="form-label" for="reportType">Report-Typ</label>
          <select class="form-select" id="reportType" formControlName="reportType">
            <option value="" disabled>Typ wählen</option>
            @for (t of reportTypes; track t) {
              <option [value]="t">{{ reportTypeLabels[t] }}</option>
            }
          </select>
          @if (isFieldInvalid('reportType')) {
            <span class="form-error">Bitte wählen Sie einen Report-Typ.</span>
          }
        </div>

        <div class="form-field">
          <label class="form-label" for="rating">Empfehlung</label>
          <select class="form-select" id="rating" formControlName="rating">
            <option value="" disabled>Empfehlung wählen</option>
            @for (r of ratings; track r) {
              <option [value]="r">{{ ratingLabels[r] }}</option>
            }
          </select>
          @if (isFieldInvalid('rating')) {
            <span class="form-error">Bitte wählen Sie eine Empfehlung.</span>
          }
        </div>
      </div>

      <!-- Titel -->
      <div class="form-row">
        <div class="form-field">
          <label class="form-label" for="title">Titel</label>
          <input class="form-input" type="text" id="title" formControlName="title" placeholder="Report-Titel eingeben">
          @if (isFieldInvalid('title')) {
            <span class="form-error">Titel muss mindestens 5 Zeichen lang sein.</span>
          }
        </div>
      </div>

      <!-- Executive Summary -->
      <div class="form-row">
        <div class="form-field">
          <label class="form-label" for="executiveSummary">Zusammenfassung</label>
          <textarea class="form-textarea" id="executiveSummary" formControlName="executiveSummary" placeholder="Executive Summary eingeben" rows="5"></textarea>
          @if (isFieldInvalid('executiveSummary')) {
            <span class="form-error">Zusammenfassung muss mindestens 20 Zeichen lang sein.</span>
          }
        </div>
      </div>

      <!-- Kursziel + Kurs + Risiko -->
      <div class="form-row form-row--3col">
        <div class="form-field">
          <label class="form-label" for="targetPrice">Kursziel (CHF)</label>
          <input class="form-input form-input--number" type="number" id="targetPrice" formControlName="targetPrice" step="0.01" min="0">
          @if (isFieldInvalid('targetPrice')) {
            <span class="form-error">Kursziel muss grösser als 0 sein.</span>
          }
        </div>

        <div class="form-field">
          <label class="form-label" for="currentPrice">Aktueller Kurs (CHF)</label>
          <input class="form-input form-input--number" type="number" id="currentPrice" formControlName="currentPrice" step="0.01" min="0">
        </div>

        <div class="form-field">
          <label class="form-label" for="riskLevel">Risikolevel</label>
          <select class="form-select" id="riskLevel" formControlName="riskLevel">
            @for (rl of riskLevels; track rl) {
              <option [value]="rl">{{ riskLevelLabels[rl] }}</option>
            }
          </select>
        </div>
      </div>

      <!-- Actions -->
      <div class="form-actions">
        <button class="btn-submit" type="submit" [disabled]="submitting()">
          @if (submitting()) {
            Wird gespeichert...
          } @else if (isEditMode()) {
            Speichern
          } @else {
            Report erstellen
          }
        </button>
        <button class="btn-cancel" type="button" (click)="onCancel()">Abbrechen</button>
      </div>

    </form>
  </div>
}
